#!/usr/bin/env node

var runner = require('..')(process.cwd());
var program = require('commander');
var join = require('path').join;
var co = require('co');

/**
 * Program
 */

program
  .usage('<path> [options]')
  .option('-c, --commands', 'shell commands to run as middleware', list, [])
  .option('-m, --middleware <file>', 'filename that exposes a function that accepts a koa app');

/**
 * Help
 */

program.on('--help', function(){
  console.log('  Examples');
  console.log();
  console.log('    # test using phantom');
  console.log('    $ duo test phantomjs /tests');
  console.log();
  console.log('    # pass arguments to mocha-phantomjs');
  console.log('    $ duo test phantomjs /tests args: --reporter dot');
  console.log();
  process.exit(0);
});

/**
 * Parse
 */

program.parse(process.argv);

/**
 * Path
 */

var path = program.args[0];

/**
 * Phantomjs args
 */

var args = (function(){
  var i = process.argv.indexOf('args:');
  if (~i) return process.argv.slice(i + 1);
  return [];
})();

/**
 * Middleware
 */

var mw = program.middleware
  ? require(join(process.cwd(), program.middleware))
  : function(){};

/**
 * Run tests
 */

co(function*(){
  runner.app.path(path);
  mw(runner.app);
  var code = yield runner.phantomjs(args);
  runner.app.destroy();
  process.exit(code);
})(error);

/**
 * List
 */

function list(val){
  if ('"' == val[0]) val = val.slice(1, -1);
  return val.split(/ *, */);
}

/**
 * Error
 */

function error(err){
  if (!err) return;
  console.error();
  console.error('  %s', err.stack || err);
  console.error();
  runner.app.destroy();
  process.exit(1);
}
